# **How to Add a New Database for a New Ancillary Study**

> Make sure to replace `{{ANCILLARY_STUDY_NAME}}` with the actual ancillary study name

1. Create a new `alembic_{{ANCILLARY_STUDY_NAME}}.ini` in the `rdr_service` directory and place the following contents

```ini
# A generic, single database configuration.
# Generated by "alembic init"

[alembic]
# path to migration scripts
script_location = alembic


# template used to generate migration files
# file_template = %%(rev)s_%%(slug)s

# max length of characters to apply to the
# "slug" field
#truncate_slug_length = 40

# set to 'true' to run the environment during
# the 'revision' command, regardless of autogenerate
# revision_environment = false

# set to 'true' to allow .pyc and .pyo files without
# a source .py file to be detected as revisions in the
# versions/ directory
# sourceless = false

# version location specification; this defaults
# to alembic/versions.  When using multiple version
# directories, initial revisions must be specified with --version-path
version_locations = %(here)s/alembic/{{ANCILLARY_STUDY_NAME}}/versions

# the output encoding used when revision files
# are written from script.py.mako
# output_encoding = utf-8

databases = {{ANCILLARY_STUDY_NAME}}

# Logging configuration
[loggers]
keys = root,sqlalchemy,alembic

[handlers]
keys = console

[formatters]
keys = generic

[logger_root]
level = WARN
handlers = console
qualname =

[logger_sqlalchemy]
level = WARN
handlers =
qualname = sqlalchemy.engine

[logger_alembic]
level = INFO
handlers =
qualname = alembic

[handler_console]
class = StreamHandler
args = (sys.stderr,)
level = NOTSET
formatter = generic

[formatter_generic]
format = %(asctime)s %(levelname)-5.5s [%(name)s] %(message)s
datefmt = %H:%M:%S


[post_write_hooks]
hooks = custom_sql_newlines
custom_sql_newlines.type = custom_sql_newlines

```


2. Create the folder mentioned in the above `version_locations` field such as `rdr_service/alembic/{{ANCILLARY_STUDY_NAME}}/versions`

3. Create a new script in `rdr_service/tools/` directory named `generate_schema_{{ANCILLARY_STUDY_NAME}}` to generate schema migrations for `{{ANCILLARY_STUDY_NAME}}` database

> For Example: Please take a look at `rdr_service/tools/generate_schema_nph.sh`

```sh
#!/bin/bash -e

# Generates a schema migration script in the "alembic/versions" directory to
# upgrade the current state of the local MySQL database to the schema declared
# in code. (If alembic/versions/ is empty and MySQL is blank, as after running
# setup_local_database.sh, this will be an initial schema version.)
#
# Run this before committing whenever you make a change to the model/ directory.

if [ -z "$1" ]
then
  echo "Usage: tools/generate_schema_{{ANCILLARY_STUDY_NAME}}.sh <MESSAGE>"
  exit 1
fi

if [ -z "${DB_CONNECTION_STRING}" ]
then
  source tools/setup_local_vars.sh
  set_local_db_connection_string alembic
fi

(source tools/set_path.sh; cd ${APP_DIR};
 alembic -c alembic_{{ANCILLARY_STUDY_NAME}}.ini revision --autogenerate -m "$1")
```

4. Create a new script in `rdr_service/tools/` directory named `upgrade_database_{{ANCILLARY_STUDY_NAME}}` to apply new schema migrations to `{{ANCILLARY_STUDY_NAME}}` database

> For Example: Please take a look at `rdr_service/tools/upgrade_database_nph.sh`

```sh
#!/bin/bash -e

# Applies schema migrations found in alembic/versions to upgrade a database.
# A specific revision level can be provided, or if none is, all revisions will be applied (i.e.
# the schema of the database will be updated to the latest.)
#
USAGE="
Examples:
Upgrade the local development database:
    tools/upgrade_database.sh [--revision <REVISION>]
Upgrade a deployed db from your development box:
    tools/upgrade_database.sh --project all-or-us-rdr-staging \
        --account $USER@google.com [--creds_account $USER@pmi-ops.org]
Upgrade a deployed db from CircleCI:
    tools/upgrade_database.sh --instance https://all-of-us-x.appspot.com --creds_file ~/creds_file.key
"

while true; do
  case "$1" in
    --revision) REVISION=$2; shift 2;;
    --account) ACCOUNT=$2; shift 2;;
    --creds_account) CREDS_ACCOUNT=$2; shift 2;;
    --project) PROJECT=$2; shift 2;;
    --instance) INSTANCE=$2; shift 2;;
    -i) INSTANCE=$2; shift 2;;
    --creds_file) CREDS_FILE=$2; shift 2;;
    -- ) shift; break ;;
    * ) break ;;
  esac
done

if [ "${PROJECT}" ]
then
  if [ -z "${ACCOUNT}" ]
  then
    echo "--account must be specified with --project. $USAGE"
    exit 1
  fi
  if [ -z "${CREDS_ACCOUNT}" ]
  then
    CREDS_ACCOUNT="${ACCOUNT}"
  fi
elif [ "${INSTANCE}" ]
then
  if [ -z "${CREDS_FILE}" ]
  then
    echo "--creds_file must be specified with --instance. $USAGE"
    exit 1
  fi
fi

if [ -z "${REVISION}" ]
then
  REVISION=heads
fi

if [ "${PROJECT}" -o "${INSTANCE}" ]
then
  source tools/auth_setup.sh
  run_cloud_sql_proxy
  set_db_connection_string alembic
else
  if [ -z ${DB_CONNECTION_STRING} ]
  then
    source tools/setup_local_vars.sh
    set_local_db_connection_string alembic
  fi
fi

# alembic.env.get_url() picks up DB_CONNECTION_STRING to find the db to upgrade.
(source tools/set_path.sh; alembic -c alembic_{{ANCILLARY_STUDY_NAME}}.ini upgrade "${REVISION}")
```

5. Update `Line 66` in `rdr_service/tools/setup_local_database.sh` to create the new `{{ANCILLARY_STUDY_NAME}}` database and set appropriate login permissions for `alembic` user

6. Add the below code snippet to `rdr_service/tools/setup_local_database.sh` at the end before you see `echo "Setting general configuration..."` statement to always apply all the db schema migrations for the new `{{ANCILLARY_STUDY_NAME}}` database when setting up local test database

```sh
echo "Updating schema to latest..."
tools/upgrade_database_{{ANCILLARY_STUDY_NAME}}.sh
```

7. Add a new declarative base as shown below for the new database in `rdr_service/model/base.py` file
```python
{{ANCILLARY_STUDY_NAME}}Base = declarative_base(cls=DictableModel, metadata=MetaData(schema="{{ANCILLARY_STUDY_NAME}}"))
```

8. Now import newly initialized declarative base for the new database in `rdr_service/alembic/env.py` file (Refer to `Line 18` in the file) and add a `key`: `value` entry to `target_metadata` mapping on `rdr_service/alembic/env.py:40`

9. Now to notify the alembic to manage the new database schema using the new declarative base metadata add a new method called `create_{{ANCILLARY_STUDY_NAME}}_schema` in `rdr_service/model/database.py::Database` class and intialize it as shown below

> For example please refer to `rdr_service.model.database.Database.create_nph_schema` method

```python
def create_{{ANCILLARY_STUDY_NAME}}_schema(self):
    {{ANCILLARY_STUDY_NAME}}Base.metadata.create_all(self._engine)
```

10. Now update `_initialize_database` method in `tests/helpers/mysql_helper.py` to manage all the database schemas during unittests. Add the below changes to the file

    1. Drop database, if it exists
        ```python
        engine.execute("DROP DATABASE IF EXISTS {{ANCILLARY_STUDY_NAME}}")
        ```

    2. Create the database
        ```python
        engine.execute("CREATE DATABASE rex CHARACTER SET utf8 COLLATE utf8_general_ci")
        ```

    3. Apply all database migrations
        ```python
        engine.execute("USE {{ANCILLARY_STUDY_NAME}}")
        database.create_{{ANCILLARY_STUDY_NAME}}_schema()
        ```
