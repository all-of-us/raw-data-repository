# Raw Data Repository API

## Purpose of this document

Describe the PMI's Raw Data Repository API, intended to support 2017
launch-time requirements. This document is version controlled; you
should read the version that lives in the branch or tag you need.

## API Overview

These are the APIs that the RDR will support for the initial launch:

* PTC to RDR (Raw Data Repository)
  * Create and update Participant information
  * Create and update Questionnaires and Responses ("PPI", Participant-provided information)
  * Read data about a participant
* Health Professional Portal to RDR
  * Search Participants
    * At check-in time, look up an individual by name, date of birth, zip code
    * For a Work Queue, filter participants based on summary information (e.g. age, race, ethnicity)
  * Get Participant Summary (by id)
  * Update a Participant with a new Medical Record Number
  * Insert results from physical measurements
  * Insert biospecimen orders
* BioBank to RDR
  * (Google Cloud Storage “add a csv file to bucket”, performed daily)
* For release management and operational monitoring
  * Serving version identifier - no auth required

## API Details

### Technologies Used

* JSON + REST
* OAuth 2.0 / Google authentication
* HTTPS
* FHIR API and resource definitions where appropriate (questionnaires, physical measurements)
* FHIR API and resource conventions elsewhere (search, biospecimen orders)
* API handlers written in Python + Flask, backed by AppEngine.
* Data stored in [Cloud Datastore](https://cloud.google.com/datastore/docs/concepts/overview) (indexed on fields required for search)

### Authentication Details

All actors calling these APIs in production will use [service accounts](https://cloud.google.com/compute/docs/access/service-accounts).

For development and testing only, they can be called with the developer’s credentials using OAuth.

We will use a Google Cloud Project owned by Vanderbilt for testing:  "PMI DRC API Test" (id: `pmi-drc-api-test`).

### Test System

The API will be set up against a Cloud Datastore instance.  Schema is evolving to support launch.

### Version Management

When updating a resource (via PATCH now; and PUT support is anticipated), the
RDR API requires a client to provide an HTTP “If-Match” header that points to
the current version of a resource. This prevents a client from blindly
overwriting data that it hasn’t had the opportunity to see yet. The client uses
the value from a resource’s “ETag” header, following RFC7232 (or, for a more
readable tutorial, see [this
article](http://fideloper.com/etags-and-optimistic-concurrency-control)).
Concretely, a request looks like:

```
PATCH /rdr/v1/Participant/P123456789
If-Match: W/"98172982174921"

{
  "providerLink": [{
    "primary": true,
    "site": "Organization/PITT",
  }]
}
```

And this request either fails (if the supplied ETag does not match the current
resource version), or it succeeds in updating the resource and returns a new

ETag in a header like like:

    ETag: W/"99817291822"

ETag values are also returned in a *`meta.versionId`* property within each
resource, following FHIR’s convention.


## Metadata API

Clients of the RDR can use this API to verify that the version they did
integration testing against matches the production version.  This API does not
check authorization because the information is not sensitive, making it
suitable for operational monitoring (uptime checks) as well.

#### `GET /`

Retrieve metadata for the server. Response is a JSON object including a
`version_id` field.  The version ID will change with each binary release.
Format and semantics of the identifier are not otherwise defined.


## Participant API

The Participant is a very thin resource—essentially it has a set of identifiers including:

* `participantId`: PMI-specific ID generated by the RDR and used for
  tracking/linking participant data. Human-readable 10-character string
beginning with `P`.
* `biobankId`: PMI-specific ID generated by the RDR and used exclusively for
  communicating with the biobank. Human-readable 10-character string beginning
with `B`.
*  `providerLink`: list of "provider link" objects indicating that this
   participant is known to a provider, including:
  * `primary`: `true` | `false`, indicating whether this provider is the "main"
    provider responsible for recruiting a participant and performing physical
    measurements and biospecimen collection
  * `organization`: Reference to an HPO organization, like `{"reference":
    "Organization/PITT"}`
  * `site`: array of
    [references](http://hl7.org/fhir/references.html#reference) to an HPO site,
    like `{"reference": "Organization/PITT_SOME_CLINIC"}`
  * `identifier`: array of
    [identifiers](http://hl7.org/fhir/datatypes#identifier)  with `system` and
    `value` indicating medical record numbers by which this participant is known

The Participant API supports the following API calls:

#### `POST /Participant`

Insert a new participant. Request body is an empty JSON document. Response is a
Participant object with newly-created ids.

#### `PATCH /Participant/:id`

Update an existing participant with new `providerLink` values. Request body is
a Participant object reflecting desired changes. Response is the Participant
object as stored.

#### `GET  /Participant/:id`

Read a single participant.

## ParticipantSummary API

The ParticipantSummary resource represents an aggregated view of relevant
participant details, including data from consent (name, contact information),
from PPI modules (a status indicating whether the participant has completed
each questionnaire), basic demographics (age, gender, race, and ethnicity).

The summary includes the following fields:

* `participantId`
* `biobankId`
* `firstName`
* `middleName`
* `lastName`
* `zipCode`
* `dateOfBirth`
* `ageRange`
* `genderIdentity`
* `membershipTier`: (TODO clarify these values)
* `race`
* `ethnicity`
* `physicalMeasurementsStatus`: indicates whether this participant has completed physical measurements
* `hpoId`: HPO marked as `primary` for this participant, if any (just the resource id, like `PITT` — not a reference like `Organization/PITT`)
* `consentForStudyEnrollment`:  indicates whether enrollment consent has been received
* `consentForElectronicHealthRecords`:  indicate whether EHR sharing consent has been received
* `questionnaireOnOverallHealth`: indicates status for Overall Health PPI module
* `questionnaireOnPersonalHabits` 
* `questionnaireOnSociodemographics`
* `questionnaireOnHealthcareAccess` 
* `questionnaireOnMedicalHistory`
* `questionnaireOnMedications`
* `questionnaireOnFamilyHealth`

For enumeration fields, the following values are defined:

`hpoId`: `UNSET`, `UNMAPPED`, `PITT`, `COLUMBIA`, `ILLINOIS`, `AZ_TUCSON`, `COMM_HEALTH`, `SAN_YSIDRO`, `CHEROKEE`, `EAU_CLAIRE`, `HRHCARE`, `JACKSON`, `GEISINGER`, `CAL_PMC`, `NE_PMC`, `TRANS_AM`, `VA`

`ageRange`: `0-17`, `18-25`, `26-35`, `36-45`, `46-55`, `56-65`, `66-75`, `76-85`, `86-`

`physicalMeasurementsStatus`: `UNSET`, `SCHEDULED`, `COMPLETED`, `RESULT_READY` 

`questionnaireOn[x]`: `UNSET`, `SUBMITTED`

`membershipTier`: `UNSET`, `SKIPPED`, `UNMAPPED`, `REGISTERED`, `ENROLLEE`, `VOLUNTEER`, `FULL_PARTICIPANT`

`genderIdentity`: `UNSET`, `SKIPPED`, `UNMAPPED`, `FEMALE`, `MALE`, `FEMALE_TO_MALE_TRANSGENDER`, `MALE_TO_FEMALE_TRANSGENDER`, `INTERSEX`, `OTHER`, `PREFER_NOT_TO_SAY`

`ethnicity`: `UNSET`, `SKIPPED`, `UNMAPPED`, `HISPANIC`, `NON_HISPANIC`, `PREFER_NOT_TO_SAY`

`race`: `UNSET`, `SKIPPED`, `UNMAPPED`, `AMERICAN_INDIAN_OR_ALASKA_NATIVE`, `BLACK_OR_AFRICAN_AMERICAN`, `ASIAN`, `NATIVE_HAWAIIAN_OR_OTHER_PACIFIC_ISLANDER`, `WHITE`, `OTHER_RACE`, `PREFER_NOT_TO_SAY`


#### `GET /ParticipantSummary?`

List participants matching a set of search parameters. This supports in-clinic
lookup (for physical measurements and biospecimen donation) as well as a
Participant Work Queue. Search parameters include:

 * `hpoId`
 * `firstName`
 * `lastName`
 * `dateOfBirth`
 * `zipCode`
 * `genderIdentity`
 * `race`
 * `ethnicity`

If no HPO is provided, then a last name and date of birth (at minimum) must be
supplied. Example query:

    GET /ParticipantSummary?dateOfBirth=1980-12-30&lastName=Smith
    GET /ParticipantSummary?hpoId=PITT&ethnicity=HISPANIC


## Questionnaire and QuestionnaireResponse API

We use the FHIR [Questionnaire](http://hl7.org/fhir/questionnaire.html) and
[QuestionnaireResponse](http://hl7.org/fhir/questionnaireresponse.html)
resources to track consent and participant-provided information. We store the
blank forms (Questionnaires) at the RDR level, and we store responses at the
participant level.


#### `POST /Questionnaire`

Create a new Questionnaire in the RDR. Body is a FHIR DSTU2 Questionnaire
resource. Response is the stored resource, which includes an `id`.

#### `GET /Questionnaire/:id`

Read a single Questionnaire from the RDR. Response is the stored resource.

#### `POST /Participant/:pid/QuestionnaireResponse`

Create a new QuestionnaireResponse in the RDR. Body is a FHIR DSTU2
QuestionnaireResponse resource which must include:

* `subject`: a reference to the participant, in the form `Patient/:pid`.  The
  `:pid` variable of this refernce must match the participant ID supplied in
  the POST URL. (Note the use of the word "Patient" here, which comes from FHIR.)

* `questionnaire`: a refernece to the questionnaire for which this response
  has been written, in the form `Questionnaire/:qid`

* `linkId`s for each question, corresponding to a `linkId` specified in the
  questionnaire

#### `GET /Participant/:pid/QuestionnaireResponse/:qid`

Example query:

    GET /Participant/P123456789/Questionnaire/810572271


## PhysicalMeasurements API

We use the FHIR `Document` model to represent a set of physical measurements
recorded at a PMI visit. This stores a `Bundle` of resources, with a
`Composition` as the first entry (listing basic metadata for the document,
including a document type, creation time, author, and an index of contents),
and a set of `Observation`s as subsequent entries (recording, for example,
individual blood pressure or weight measurements).


#### `POST /Participant/:pid/PhysicalMeasurements`

Create a new PhysicalMeasurements for a given participant. The payload is a
Bundle (see
[example](https://github.com/vanderbilt/pmi-data/blob/master/rest-api/test/test-data/measurements-as-fhir.json))
where the first entry is a `Composition` including:

* `subject`: a reference to the participant, in the form `Patient/:pid`.  The
  `:pid` variable of this refernce must match the participant ID supplied in
  the POST URL. (Note the use of the word "Patient" here, which comes from FHIR.)

* `type`: a coding indicating the document type. This should have a `system` of
  `http://terminology.pmi-ops.org/CodeSystem/document-type`, so the compete type looks like:

```
"type": {
  "coding": [{
    "system": "http://terminology.pmi-ops.org/CodeSystem/document-type",
    "code": "intake-exam-v0.0.1",
    "display": "PMI Intake Measurements v0.0.1"
  }]
}

```

* a series of `Observation`s each with times, codes, and values. 

See also: [Physical measurements form
specs](https://docs.google.com/spreadsheets/d/10kYqLSPigl02jUBpwEHpGAHwuwExFu-BedvMOJ5afpE/edit#gid=0)
and
[methods](https://drive.google.com/file/d/0B7ko4YYX_fIca0QwRWx5VkdfSW1SSWFldWN2UTZtWFNMTS1B/view)

#### `POST /Participant/:pid/PhysicalMeasurements`

Create a new PhysicalMeasurements for a given participant. Request body is a FHIR
Document-type Bundle. Response is the resource as stored.

#### `GET /Participant/:pid/PhysicalMeasurements/:id`

Read PhysicalMeasurements by id.

#### `GET /Participant/:pid/PhysicalMeasurements`

Search for all PhysicalMeasurements available for a given participant. Response
body is a Bundle (possibly empty) of documents (that is: a bundle of search
results whose entries are bundles of measurements).


## BiobankOrder API

Maintains records of orders placed from HealthPro to the Biobank. Each order is
a resource [as documented
here](https://docs.google.com/document/d/1nTvFU3V7ssizGwdwzlc0-EfByTGCBoEjJOzQ-YKExqc/edit),
including:

* `subject`: a reference to the participant, in the form `Patient/:pid`.  The
  `:pid` variable of this refernce must match the participant ID supplied in
  the POST URL. (Note the use of the word "Patient" here, which comes from FHIR.)

* `identifier`: an array of Identifiers, each with a `system` and `value`.
  These should include the HealthPro identifier for this order as well as the
biobank identifier for this order.


#### `POST /Participant/:pid/BiobankOrder`

Create a new BiobankOrder for a given participant. Request body is a
BiobankOrder resource to be created. Response is the resource as stored.

#### `GET /Participant/:pid/BiobankOrder/:oid`

Read a BiobankOrder by id.

#### `GET /Participant/:pid/BiobankOrder`

Search for BiobankOrders about a given participant. Response body is a bundle
of BiobankOrders (possibly empty).

## Metrics API

Metrics provide a high-level overview of participants counts by date for a
variety of metrics (e.g. by race, ethnicity, or consent status). These can be
broken down by "facet" (e.g. HPO). These metrics are intended to provide "just
enough" data to drive known launch-time dashboard requirements. (Different
technology will be required to provide a flexible ad-hoc analysis system.)

#### `POST /Metrics`

Retrieve RDR metrics up to the present time. The request body can optionally
include a list of facets, like:

```
{
  "facets": ["HPO_ID"]
}
```

Currently `HPO_ID` is the only facet supported.

The response body includes:

* `field_definition`: an array of fields that appear in the returned metrics. Each field is an object with a name and array of values, like:


```
{
  "name": "Participant.genderIdentity", 
  "values": [
    "FEMALE", 
    "MALE", 
    "FEMALE_TO_MALE_TRANSGENDER", 
    "MALE_TO_FEMALE_TRANSGENDER", 
    "INTERSEX", 
    "OTHER", 
    "PREFER_NOT_TO_SAY"
  ]
}
```

## BiobankSamples API

Mayo has defined a sample manifest format that will be uploaded to the RDR
daily. The RDR scans this manifest and uses it to populate `BiobankSamples`
resources. Once these are created, a client can query for available samples:

#### TODO `GET /Participant/:pid/BiobankSamples

