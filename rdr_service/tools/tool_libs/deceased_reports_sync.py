
from rdr_service.tools.tool_libs.tool_base import cli_run, ToolBase
from rdr_service.services.consent.files import ConsentFileAbstractFactory
from rdr_service.services.consent.validation import ConsentValidator

from rdr_service.model.participant_summary import ParticipantSummary
from typing import List
from rdr_service.storage import GoogleCloudStorageProvider
from pprint import pprint
from rdr_service.model.consent_file import ConsentFile, ConsentSyncStatus
from rdr_service.participant_enums import QuestionnaireStatus


tool_cmd = 'deceased-sync'
tool_desc = 'Sync deceased reports from Redcap to an environment'


class DeceasedSyncTool(ToolBase):

    @classmethod
    def get_result_output(cls, result: ConsentFile):
        return [
            f'{result.sync_status}',
            f'signature: {"<image>" if result.is_signature_image else result.signature_str}',
            f'expected {result.expected_sign_date}',
            f'actual   {result.signing_date}{"" if result.is_signing_date_valid else " (mismatch)"}',
            f'uploaded {result.file_upload_time}',
            f'other errors: {result.other_errors or ""}'
        ]

    @classmethod
    def process_results(cls, participant_output, results, type_str):
        if not results:
            participant_output[type_str] = ['NEEDS_CORRECTING: MISSING FILE']
        elif not any([result.sync_status == ConsentSyncStatus.READY_FOR_SYNC for result in results]):
            participant_output[type_str] = [
                cls.get_result_output(result) for result in results
            ]

    def run(self):
        super(DeceasedSyncTool, self).run()
        storage_provider = GoogleCloudStorageProvider()

        with self.get_session() as session:
            participant_summaries: List[ParticipantSummary] = session.query(ParticipantSummary).filter(
                ParticipantSummary.participantId.in_([
                    348005958,
                    624442547,
                    925194905,
                    903028019,
                    364032999,
                    229668797,
                    291471088,
                    556017775,
                    427958594,
                    607980050,
                    944384605,
                    946287771,
                    955656355,
                    798959694,
                    608654961,
                    405860369,
                    987585044,
                    346289187,
                    497532348,
                    720434554,
                    481041965,
                    781975948,
                    100497615,
                    550639768,
                    267762274,
                    830600674,
                    188110853,
                    362511710,
                    648426317,
                    804217073,
                    523676982,
                    433733096,
                    138096001,
                    491506286,
                    507787461,
                    227526407,
                    988708109,
                    159430049,
                    426705266,
                    432127712,
                    302912843,
                    903156030,
                    819793353,
                    819487830,
                    508656608,
                    737581904,
                    508656608,
                    569110676,
                    745063815,
                    745063815,
                    745063815,
                    787161033,
                    787161033,
                    560238045,
                    132228599,
                    563854723,
                    132228599,
                    956722970,
                    132228599,
                    956722970,
                    591417408,
                    105138683,
                    605392125,
                    284937885,
                    729206233,
                    562333644,
                    421723353,
                    473933936,
                    463291171,
                    101165291,
                    400363684,
                    311369991,
                    593634990,
                    101165291,
                    744750113,
                    101165291,
                    400363684,
                    744750113,
                    400363684,
                    389124812,
                    972797581,
                    311369991,
                    311369991,
                    311116141,
                    663946163,
                    109678017,
                    725787810,
                    672412510,
                    231086364,
                    725787810,
                    725787810,
                    212537416,
                    766890873,
                    759165338,
                    584334520,
                    999446239,
                    131918901,
                    999446239,
                    852148868,
                    624392841,
                    367310898,
                    624392841,
                    624392841,
                    471180190,
                    471180190,
                    769257839,
                    471180190,
                    852867071,
                    852867071,
                    852867071,
                    760119072,
                    358289139,
                    429174948,
                    755628786,
                    744750113,
                    564452251,
                    679612152,
                    789577709,
                    956068354,
                    789577709,
                    789577709,
                    942912056,
                    483766641,
                    243718233,
                    915050886,
                    459907286,
                    791062813,
                    911652541,
                    459907286,
                    459907286,
                    911652541,
                    911652541,
                    480345571,
                    791062813,
                    791062813,
                    732155688,
                    438929060,
                    594801556,
                    109678017,
                    772079473,
                    594801556,
                    594801556,
                    772079473,
                    572279681,
                    219896983,
                    219896983,
                    174333662,
                    853018407,
                    853018407,
                    772079473,
                    691771379,
                    266925642,
                    944291310,
                    946721365,
                    715922900,
                    689742514,
                    819205006,
                    735245956,
                    689742514,
                    689742514,
                    913710217,
                    415094034,
                    371085166,
                    157819400,
                    178550450,
                    996738350,
                    324598725,
                    340052114,
                    531137364,
                    595813698,
                    405860369,
                    405860369,
                    882730667,
                    971755425,
                    952860585,
                    127500606,
                    170765768,
                    546419295,
                    955656355,
                    955656355,
                    854838533,
                    509856268,
                    546419295,
                    854838533,
                    591417408,
                    692558598,
                    164924630,
                    633297150,
                    201194962,
                    651525452,
                    363892801,
                    803515816,
                    651525452,
                    744208192,
                    651525452,
                    245043470,
                    360699718,
                    971755425,
                    707247709,
                    768547743,
                    707247709,
                    768547743,
                    360699718,
                    773397945,
                    360699718,
                    432138639,
                    637587975,
                    195730937,
                    792205428,
                    707247709,
                    248756212,
                    142503948,
                    792205428,
                    987585044,
                    987585044,
                    494768691,
                    792205428,
                    494768691,
                    609745249,
                    999965641,
                    785432383,
                    494768691,
                    633297150,
                    781683040,
                    781683040,
                    387767010,
                    755675984,
                    543256655,
                    529921155,
                    543256655,
                    307535271,
                    740735115,
                    578232484,
                    849011353,
                    973229106,
                    849011353,
                    849011353,
                    420658574,
                    989445822,
                    961433663,
                    146460369,
                    482294612,
                    973229106,
                    533620397,
                    973229106,
                    836725298,
                    528792400,
                    553167451,
                    667420123,
                    649868122,
                    836725298,
                    528792400,
                    514636622,
                    775008600,
                    157314345,
                    903350968,
                    598526757,
                    284669035,
                    673326886,
                    538850790,
                    461129310,
                    818322216,
                    269924448,
                    538850790,
                    673326886,
                    673326886,
                    538850790,
                    528792400,
                    267762274,
                    333381477,
                    269924448,
                    269924448,
                    275372362,
                    143573028,
                    143573028,
                    143573028,
                    637587975,
                    661301097,
                    637587975,
                    918666360,
                    681317628,
                    146771569,
                    146771569,
                    146771569,
                    188110853,
                    923311572,
                    646247523,
                    977561260,
                    188868166,
                    762229556,
                    762229556,
                    257586695,
                    257586695,
                    162059363,
                    247247231,
                    972593074,
                    257586695,
                    276042391,
                    247247231,
                    143500754,
                    972593074,
                    972593074,
                    855926935,
                    162059363,
                    247247231,
                    162911912,
                    162059363,
                    685811752,
                    530699628,
                    301751914,
                    254933893,
                    113777499,
                    570623947,
                    354120159,
                    669011824,
                    530358089,
                    549049070,
                    932961373,
                    289935906,
                    530358089,
                    969476544,
                    530358089,
                    910722243,
                    293399525,
                    121323959,
                    107958946,
                    293399525,
                    433465636,
                    647055576,
                    532213930,
                    487067354,
                    562957448,
                    194026337,
                    323307546,
                    237737779,
                    318183075,
                    346527467,
                    751510083,
                    346527467,
                    943863254,
                    148881172,
                    703632005,
                    581048378,
                    590500096,
                    537837446,
                    533620397,
                    406386876,
                    879105899,
                    562957448,
                    562957448,
                    572909120,
                    486592981,
                    879105899,
                    879105899,
                    581048378,
                    486592981,
                    422077630,
                    786808846,
                    437364626,
                    572909120,
                    572909120,
                    422077630,
                    422077630,
                    908748690,
                    286823193,
                    867004389,
                    908748690,
                    908748690,
                    775483143,
                    239519151,
                    139216920,
                    366271663,
                    912441174,
                    552320314,
                    162531576,
                    798226300,
                    590500096,
                    239519151,
                    590500096,
                    912441174,
                    300640065,
                    608654961,
                    608654961,
                    754398127,
                    447646295,
                    392202370,
                    446106876,
                    813533020,
                    308727400,
                    278305829,
                    460684895,
                    654039701,
                    834425923,
                    239519151,
                    770399740,
                    315174015,
                    300640065,
                    100170541,
                    300640065,
                    161934537,
                    733770944,
                    720726224,
                    937468110,
                    162911912,
                    161934537,
                    981823173,
                    521961296,
                    810689557,
                    161934537,
                    514361600,
                    330033507,
                    854603518,
                    760119072,
                    680196039,
                    351361317,
                    680196039,
                    680196039,
                    564686841,
                    608944253,
                    355824009,
                    164717036,
                    956558617,
                    191583074,
                    176139553,
                    410291307,
                    164717036,
                    864519640,
                    690565005,
                    956558617,
                    864519640,
                    864519640,
                    811098946,
                    176139553,
                    191583074,
                    735491151,
                    687441112,
                    291471088,
                    291471088,
                    269034186,
                    386196592,
                    558215173,
                    472130985,
                    458022217,
                    624675828,
                    472130985,
                    654193005,
                    970715636,
                    138042391,
                    841791626,
                    239114542,
                    766890873,
                    358289139,
                    358289139,
                    587486663,
                    795981955,
                    624442547,
                    573790751,
                    638694195,
                    239114542,
                    767626772,
                    177588667,
                    767626772,
                    854430742,
                    767626772,
                    803747281,
                    177588667,
                    803747281,
                    176139553,
                    803747281,
                    733015202,
                    719896172,
                    177588667,
                    604389936,
                    733015202,
                    733015202,
                    719896172,
                    719896172,
                    133532037,
                    523676982,
                    703632005,
                    329370339,
                    813963412,
                    528905312,
                    952291873,
                    952291873,
                    754896542,
                    458274898,
                    754896542,
                    952291873,
                    754896542,
                    267762274,
                    679700191,
                    690823551,
                    690823551,
                    690823551,
                    761254205,
                    188993667,
                    188993667,
                    188993667,
                    447015559,
                    688842358,
                    624289319,
                    698744212,
                    698744212,
                    472130985,
                    433733096,
                    166163527,
                    455836174,
                    697087287,
                    166163527,
                    767644954,
                    834369083,
                    938990903,
                    335556664,
                    287413448,
                    834369083,
                    680516102,
                    834369083,
                    680516102,
                    189710419,
                    937468110,
                    937468110,
                    680516102,
                    511594947,
                    229032110,
                    130271521,
                    952981435,
                    938990903,
                    306156046,
                    496300301,
                    634413411,
                    938990903,
                    634413411,
                    299713163,
                    634413411,
                    841037897,
                    988675161,
                    404229013,
                    742125436,
                    841037897,
                    841037897,
                    144749321,
                    368774922,
                    938211488,
                    484403113,
                    988675161,
                    299713163,
                    338489101,
                    476195368,
                    855700680,
                    612957509,
                    484403113,
                    404229013,
                    742125436,
                    476195368,
                    233626761,
                    506039867,
                    484403113,
                    528177818,
                    855700680,
                    965855325,
                    975652808,
                    537207633,
                    793103846,
                    855700680,
                    965855325,
                    294367158,
                    389885847,
                    880054291,
                    528177818,
                    474041238,
                    906695670,
                    233626761,
                    517931690,
                    364987210,
                    906695670,
                    906695670,
                    932296772,
                    780491463,
                    389885847,
                    183476892,
                    581048378,
                    315174015,
                    506478429,
                    698744212,
                    301836245,
                    301836245,
                    333577589,
                    301836245,
                    194043096,
                    231753657,
                    455836174,
                    502869383,
                    533211302,
                    220280812,
                    506478429,
                    533211302,
                    506478429,
                    934015879,
                    907331915,
                    598227673,
                    389885847,
                    925824370,
                    574967188,
                    220280812,
                    598227673,
                    333577589,
                    780491463,
                    217629193,
                    220280812,
                    598227673,
                    489162314,
                    568787268,
                    455836174,
                    608747895,
                    589460612,
                    286636445,
                    922864724,
                    631992229,
                    221841086,
                    638574612,
                    143091333,
                    568787268,
                    922864724,
                    922864724,
                    278305829,
                    278305829,
                    489162314,
                    489162314,
                    873616040,
                    425658395,
                    695537517,
                    780491463,
                    882051142,
                    930010454,
                    143091333,
                    143091333,
                    323937190,
                    369402733,
                    852782814,
                    650905526,
                    369402733,
                    137765622,
                    422448951,
                    475072052,
                    333577589,
                    832097543,
                    999259147,
                    862115523,
                    674230156,
                    862115523,
                    659863924,
                    862115523,
                    108953555,
                    422448951,
                    353535934,
                    250281380,
                    717727562,
                    353535934,
                    686652132,
                    954223538,
                    747052662,
                    595739055,
                    654193005,
                    311578489,
                    717417667,
                    717727562,
                    881437194,
                    564102682,
                    332036055,
                    542706882,
                    425511551,
                    849852749,
                    236628919,
                    564102682,
                    564102682,
                    425511551,
                    881437194,
                    849852749,
                    849852749,
                    197098730,
                    476602721,
                    188806000,
                    188720015,
                    673961781,
                    463552953,
                    463552953,
                    463552953,
                    738617715,
                    265694611,
                    346289187,
                    932089128,
                    188806000,
                    188806000,
                    738617715,
                    738617715,
                    593406263,
                    579322948,
                    342081038,
                    550769327,
                    929811159,
                    346289187,
                    269034186,
                    932089128,
                    955788494,
                    579322948,
                    955788494,
                    955788494,
                    415702621,
                    926612824,
                    340052114,
                    792047279,
                    139807294,
                    161926623,
                    161926623,
                    161926623,
                    834407895,
                    834407895,
                    834407895,
                    422328116,
                    422328116,
                    893046195,
                    506972884,
                    338594407,
                    893046195,
                    158460917,
                    988675161,
                    338594407,
                    338594407,
                    845265624,
                    100343546,
                    385467399,
                    151638291,
                    856536008,
                    233626761,
                    433487764,
                    231728618,
                    433487764,
                    952996258,
                    231728618,
                    830037908,
                    892185667,
                    981126949,
                    151638291,
                    311578489,
                    660504617,
                    889148921,
                    981126949,
                    830037908,
                    830037908,
                    185535668,
                    151638291,
                    162911912,
                    981126949,
                    122098882,
                    163910710,
                    546441911,
                    867004389,
                    890456016,
                    931839404,
                    458653804,
                    517525465,
                    122098882,
                    122098882,
                    964083097,
                    761681191,
                    267856226,
                    269247240,
                    342916292,
                    964083097,
                    348005958,
                    348005958,
                    458653804,
                    458653804,
                    303340617,
                    195815209,
                    547884526,
                    964083097,
                    208255041,
                    195815209,
                    303340617,
                    931839404,
                    931839404,
                    341015088,
                    342916292,
                    267856226,
                    167765699,
                    267856226,
                    510264266,
                    607530443,
                    303340617,
                    828311653,
                    340104217,
                    634473732,
                    828311653,
                    500655690,
                    828311653,
                    195815209,
                    859119219,
                    738545972,
                    738545972,
                    500655690,
                    431003647,
                    563475691,
                    960841213,
                    223532541,
                    783668308,
                    500655690,
                    647963089,
                    717959692,
                    587932721,
                    431003647,
                    984539542,
                    431003647,
                    830600674,
                    141942817,
                    828844439,
                    329047990,
                    496277854,
                    830600674,
                    754484024,
                    356522748,
                    208255041,
                    969826184,
                    208255041,
                    949680310,
                    828844439,
                    828844439,
                    287114458,
                    605600745,
                    467057769,
                    963419389,
                    605600745,
                    223532541,
                    223532541,
                    385542873,
                    467057769,
                    260467453,
                    467057769,
                    188110853,
                    204970313,
                    974096992,
                    353680137,
                    260467453,
                    260467453,
                    430640377,
                    328129800,
                    773944499,
                    336357199,
                    921867416,
                    881437194,
                    328129800,
                    328129800,
                    353680137,
                    353680137,
                    172228784,
                    992587186,
                    700776424,
                    206494082,
                    928392783,
                    962715170,
                    308727400,
                    206494082,
                    467934132,
                    162002518,
                    206494082,
                    351361317,
                    351361317,
                    962715170,
                    599826366,
                    720281122,
                    599826366,
                    116503662,
                    583838102,
                    720281122,
                    581507000,
                    180679119,
                    608944253,
                    608944253,
                    720281122,
                    933617226,
                    492230871,
                    805708002,
                    492230871,
                    575871321,
                    492230871,
                    286758497,
                    921370759,
                    933617226,
                    933617226,
                    581507000,
                    581507000,
                    867004389,
                    236484149,
                    999133688,
                    558952966,
                    286758497,
                    647679097,
                    236484149,
                    141973657,
                    917148891,
                    236484149,
                    664264728,
                    579322948,
                    558952966,
                    143886591,
                    664264728,
                    664264728,
                    459798781,
                    182094778,
                    558952966,
                    962033753,
                    642466573,
                    143886591,
                    853354488,
                    340104217,
                    340104217,
                    163910710,
                    163910710,
                    648873623,
                    894550044,
                    493555867,
                    341347881,
                    786808846,
                    531322351,
                    422448951,
                    531322351,
                    531322351,
                    318142549,
                    318142549,
                    300783076,
                    560837448,
                    564903403,
                    587541009,
                    229463799,
                    564903403,
                    138148073,
                    792599801,
                    773977821,
                    773977821,
                    773977821,
                    407758306,
                    464392639,
                    669602099,
                    307205818,
                    878892686,
                    699617658,
                    647055576,
                    647055576,
                    829845314,
                    459798781,
                    251308730,
                    878892686,
                    829845314,
                    832245668,
                    261607989,
                    261607989,
                    632831158,
                    610424368,
                    261607989,
                    675179748,
                    648498648,
                    675179748,
                    799795544,
                    876883264,
                    877029865,
                    930010454,
                    607755931,
                    675179748,
                    979818057,
                    421246194,
                    607755931,
                    759355298,
                    877029865,
                    877029865,
                    718835156,
                    962715170,
                    698351537,
                    609849801,
                    930010454,
                    143919722,
                    113237830,
                    433733096,
                    698351537,
                    645646606,
                    943458882,
                    645646606,
                    645646606,
                    231290611,
                    475866575,
                    744951044,
                    324341143,
                    417830446,
                    235016678,
                    324341143,
                    324341143,
                    231290611,
                    390123365,
                    475866575,
                    314453343,
                    919260151,
                    235016678,
                    235016678,
                    206048926,
                    157829146,
                    846365983,
                    787125098,
                    173746797,
                    842176231,
                    428298378,
                    842176231,
                    404880774,
                    842176231,
                    475866575,
                    428298378,
                    428298378,
                    390123365,
                    787125098,
                    157829146,
                    869606581,
                    186018438,
                    694817861,
                    390123365,
                    164717036,
                    561434592,
                    346635133,
                    573941952,
                    211193356,
                    572752447,
                    558079173,
                    229668797,
                    939143790,
                    233442152,
                    954223538,
                    954223538,
                    331278089,
                    979444729,
                    961163308,
                    177547950,
                    319086396,
                    205987242,
                    297897881
                ])
            ).order_by(ParticipantSummary.participantId).all()

        validation_data = {}

        for summary in participant_summaries:
            print(f'checking {summary.participantId}')
            factory = ConsentFileAbstractFactory.get_file_factory(
                participant_id=summary.participantId,
                participant_origin=summary.participantOrigin,
                storage_provider=storage_provider
            )
            validator = ConsentValidator(
                consent_factory=factory,
                participant_summary=summary,
                va_hpo_id=15
            )

            participant_output = {}

            if summary.consentForStudyEnrollment == QuestionnaireStatus.SUBMITTED:
                self.process_results(
                    participant_output,
                    results=validator.get_primary_validation_results(),
                    type_str='Primary'
                )
            if summary.consentForCABoR == QuestionnaireStatus.SUBMITTED:
                self.process_results(
                    participant_output,
                    results=validator.get_cabor_validation_results(),
                    type_str='Cabor  '
                )
            if summary.consentForElectronicHealthRecords == QuestionnaireStatus.SUBMITTED:
                self.process_results(
                    participant_output,
                    results=validator.get_ehr_validation_results(),
                    type_str='EHR    '
                )
            if summary.consentForGenomicsROR == QuestionnaireStatus.SUBMITTED:
                self.process_results(
                    participant_output,
                    results=validator.get_gror_validation_results(),
                    type_str='GROR   '
                )

            if participant_output:
                validation_data[f'P{summary.participantId}'] = participant_output

        pprint(validation_data)


def run():
    return cli_run(tool_cmd, tool_desc, DeceasedSyncTool)
