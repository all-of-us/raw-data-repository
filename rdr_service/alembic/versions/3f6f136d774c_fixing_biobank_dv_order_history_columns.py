"""fixing biobank_dv_order_history columns.

Revision ID: 3f6f136d774c
Revises: 748eae0e20db
Create Date: 2019-10-15 12:22:26.512027

"""
from alembic import op
import sqlalchemy as sa
import rdr_service.model.utils
from sqlalchemy.dialects import mysql

from rdr_service.participant_enums import PhysicalMeasurementsStatus, QuestionnaireStatus, OrderStatus
from rdr_service.participant_enums import WithdrawalStatus, WithdrawalReason, SuspensionStatus, QuestionnaireDefinitionStatus
from rdr_service.participant_enums import EnrollmentStatus, Race, SampleStatus, OrganizationType, BiobankOrderStatus
from rdr_service.participant_enums import OrderShipmentTrackingStatus, OrderShipmentStatus
from rdr_service.participant_enums import MetricSetType, MetricsKey, GenderIdentity
from rdr_service.model.base import add_table_history_table, drop_table_history_table
from rdr_service.model.code import CodeType
from rdr_service.model.site_enums import SiteStatus, EnrollingStatus, DigitalSchedulingStatus, ObsoleteStatus

# revision identifiers, used by Alembic.
revision = '3f6f136d774c'
down_revision = '748eae0e20db'
branch_labels = None
depends_on = None


def upgrade(engine_name):
    globals()[f"upgrade_{engine_name}"]()


def downgrade(engine_name):
    globals()[f"downgrade_{engine_name}"]()



def upgrade_rdr():
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column('bigquery_sync', 'project_id',
               existing_type=mysql.VARCHAR(length=80),
               nullable=True)
    # ### end Alembic commands ###

    # Make a bkup_ table
    op.execute(
      """
      CREATE TABLE `bkup_biobank_dv_order_history` (
          `revision_action` varchar(8) DEFAULT 'insert',
          `revision_id` int(6) NOT NULL AUTO_INCREMENT,
          `revision_dt` datetime(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
          `id` int(11) NOT NULL,
          `created` datetime(6) DEFAULT CURRENT_TIMESTAMP(6),
          `modified` datetime(6) DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
          `participant_id` int(11) NOT NULL,
          `order_id` int(11) DEFAULT NULL,
          `order_date` datetime(6) DEFAULT NULL,
          `supplier` varchar(80) DEFAULT NULL,
          `supplier_status` varchar(30) DEFAULT NULL,
          `item_name` varchar(80) DEFAULT NULL,
          `item_sku_code` varchar(80) DEFAULT NULL,
          `item_snomed_code` varchar(80) DEFAULT NULL,
          `item_quantity` int(11) DEFAULT NULL,
          `street_address_1` varchar(255) DEFAULT NULL,
          `street_address_2` varchar(255) DEFAULT NULL,
          `city` varchar(255) DEFAULT NULL,
          `state_id` int(11) DEFAULT NULL,
          `zip_code` varchar(10) DEFAULT NULL,
          `biobank_street_address_1` varchar(255) DEFAULT NULL,
          `biobank_street_address_2` varchar(255) DEFAULT NULL,
          `biobank_city` varchar(255) DEFAULT NULL,
          `biobank_state_id` int(11) DEFAULT NULL,
          `biobank_zip_code` varchar(10) DEFAULT NULL,
          `shipment_last_update` datetime(6) DEFAULT NULL,
          `tracking_id` varchar(80) DEFAULT NULL,
          `biobank_tracking_id` varchar(80) DEFAULT NULL,
          `order_type` varchar(80) DEFAULT NULL,
          `order_status` smallint(6) DEFAULT NULL,
          `shipment_carrier` varchar(80) DEFAULT NULL,
          `shipment_est_arrival` datetime(6) DEFAULT NULL,
          `shipment_status` smallint(6) DEFAULT NULL,
          `barcode` varchar(80) DEFAULT NULL,
          `biobank_order_id` varchar(80) DEFAULT NULL,
          `biobank_reference` varchar(80) DEFAULT NULL,
          `biobank_status` varchar(30) DEFAULT NULL,
          `biobank_received` datetime(6) DEFAULT NULL,
          `biobank_requisition` text,
          PRIMARY KEY (`id`,`revision_id`),
          KEY `idx_revision` (`revision_id`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
      """
    )

    op.execute(
      "INSERT INTO bkup_biobank_dv_order_history SELECT * FROM biobank_dv_order_history;"
    )

    # PREP THE tmp_ TABLE
    # create the tmp_ table with a `version` column and sans `biobank_referece`
    op.execute(
      """
      CREATE TABLE `tmp_biobank_dv_order_history` (
          `revision_action` varchar(8) DEFAULT 'insert',
          `revision_id` int(6) NOT NULL AUTO_INCREMENT,
          `revision_dt` datetime(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
          `id` int(11) NOT NULL,
          `created` datetime(6) DEFAULT CURRENT_TIMESTAMP(6),
          `modified` datetime(6) DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
          `participant_id` int(11) NOT NULL,
          `order_id` int(11) DEFAULT NULL,
          `order_date` datetime(6) DEFAULT NULL,
          `supplier` varchar(80) DEFAULT NULL,
          `supplier_status` varchar(30) DEFAULT NULL,
          `item_name` varchar(80) DEFAULT NULL,
          `item_sku_code` varchar(80) DEFAULT NULL,
          `item_snomed_code` varchar(80) DEFAULT NULL,
          `item_quantity` int(11) DEFAULT NULL,
          `street_address_1` varchar(255) DEFAULT NULL,
          `street_address_2` varchar(255) DEFAULT NULL,
          `city` varchar(255) DEFAULT NULL,
          `state_id` int(11) DEFAULT NULL,
          `zip_code` varchar(10) DEFAULT NULL,
          `biobank_street_address_1` varchar(255) DEFAULT NULL,
          `biobank_street_address_2` varchar(255) DEFAULT NULL,
          `biobank_city` varchar(255) DEFAULT NULL,
          `biobank_state_id` int(11) DEFAULT NULL,
          `biobank_zip_code` varchar(10) DEFAULT NULL,
          `shipment_last_update` datetime(6) DEFAULT NULL,
          `tracking_id` varchar(80) DEFAULT NULL,
          `biobank_tracking_id` varchar(80) DEFAULT NULL,
          `order_type` varchar(80) DEFAULT NULL,
          `order_status` smallint(6) DEFAULT NULL,
          `shipment_carrier` varchar(80) DEFAULT NULL,
          `shipment_est_arrival` datetime(6) DEFAULT NULL,
          `shipment_status` smallint(6) DEFAULT NULL,
          `barcode` varchar(80) DEFAULT NULL,
          `biobank_order_id` varchar(80) DEFAULT NULL,
          `biobank_status` varchar(30) DEFAULT NULL,
          `biobank_received` datetime(6) DEFAULT NULL,
          `biobank_requisition` text,
          `version` int(11) NOT NULL,
          PRIMARY KEY (`id`,`revision_id`),
          KEY `idx_revision` (`revision_id`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
      """
    )

    # Fill with data in the correct columns
    op.execute(
      """
      INSERT INTO tmp_biobank_dv_order_history
          (revision_action, revision_id, revision_dt, id, created,
           modified, participant_id, order_id, order_date, supplier, supplier_status,
           item_name, item_sku_code, item_snomed_code, item_quantity,
           street_address_1, street_address_2, city, state_id, zip_code,
           biobank_street_address_1, biobank_street_address_2, biobank_city, biobank_state_id,
           biobank_zip_code, shipment_last_update, tracking_id, biobank_tracking_id, order_type,
           order_status, shipment_carrier, shipment_est_arrival, shipment_status, barcode, biobank_order_id,
           biobank_status, biobank_received, biobank_requisition, version)
      SELECT
          revision_action, revision_id, revision_dt, id, created,
          modified, participant_id, order_id, order_date, supplier, supplier_status,
          item_name, item_sku_code, item_snomed_code, item_quantity,
          street_address_1, street_address_2, city, state_id, zip_code,
          biobank_street_address_1, biobank_street_address_2, biobank_city, biobank_state_id,
          biobank_zip_code, shipment_last_update, tracking_id, biobank_tracking_id, order_type,
          order_status, shipment_carrier, shipment_est_arrival, shipment_status, barcode, biobank_order_id,
          biobank_reference, biobank_status, biobank_received, biobank_requisition
      FROM biobank_dv_order_history;
      """
    )

    # Replace the current table with temp table data
    # first get rid of current table
    op.execute(
      "DROP TABLE biobank_dv_order_history;"
    )

    # create the table again based on tmp_ table data
    op.execute(
      """
      CREATE TABLE `biobank_dv_order_history` (
          `revision_action` varchar(8) DEFAULT 'insert',
          `revision_id` int(6) NOT NULL AUTO_INCREMENT,
          `revision_dt` datetime(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
          `id` int(11) NOT NULL,
          `created` datetime(6) DEFAULT CURRENT_TIMESTAMP(6),
          `modified` datetime(6) DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
          `participant_id` int(11) NOT NULL,
          `order_id` int(11) DEFAULT NULL,
          `order_date` datetime(6) DEFAULT NULL,
          `supplier` varchar(80) DEFAULT NULL,
          `supplier_status` varchar(30) DEFAULT NULL,
          `item_name` varchar(80) DEFAULT NULL,
          `item_sku_code` varchar(80) DEFAULT NULL,
          `item_snomed_code` varchar(80) DEFAULT NULL,
          `item_quantity` int(11) DEFAULT NULL,
          `street_address_1` varchar(255) DEFAULT NULL,
          `street_address_2` varchar(255) DEFAULT NULL,
          `city` varchar(255) DEFAULT NULL,
          `state_id` int(11) DEFAULT NULL,
          `zip_code` varchar(10) DEFAULT NULL,
          `biobank_street_address_1` varchar(255) DEFAULT NULL,
          `biobank_street_address_2` varchar(255) DEFAULT NULL,
          `biobank_city` varchar(255) DEFAULT NULL,
          `biobank_state_id` int(11) DEFAULT NULL,
          `biobank_zip_code` varchar(10) DEFAULT NULL,
          `shipment_last_update` datetime(6) DEFAULT NULL,
          `tracking_id` varchar(80) DEFAULT NULL,
          `biobank_tracking_id` varchar(80) DEFAULT NULL,
          `order_type` varchar(80) DEFAULT NULL,
          `order_status` smallint(6) DEFAULT NULL,
          `shipment_carrier` varchar(80) DEFAULT NULL,
          `shipment_est_arrival` datetime(6) DEFAULT NULL,
          `shipment_status` smallint(6) DEFAULT NULL,
          `barcode` varchar(80) DEFAULT NULL,
          `biobank_order_id` varchar(80) DEFAULT NULL,
          `biobank_status` varchar(30) DEFAULT NULL,
          `biobank_received` datetime(6) DEFAULT NULL,
          `biobank_requisition` text,
          `version` int(11) NOT NULL,
          PRIMARY KEY (`id`,`revision_id`),
          KEY `idx_revision` (`revision_id`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
      """
    )

    op.execute(
      "INSERT INTO biobank_dv_order_history SELECT * FROM tmp_biobank_dv_order_history;"
    )

    # Remove the tmp_ table
    op.execute("DROP TABLE tmp_biobank_dv_order_history;")

    # Removing the bkup_ table
    # op.execute("DROP TABLE bkup_biobank_dv_order_history;")


def downgrade_rdr():
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column('bigquery_sync', 'project_id',
               existing_type=mysql.VARCHAR(length=80),
               nullable=False)
    # ### end Alembic commands ###


def upgrade_metrics():
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###


def downgrade_metrics():
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###
