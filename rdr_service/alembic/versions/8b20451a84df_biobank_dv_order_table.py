"""Biobank DV order table

Revision ID: 8b20451a84df
Revises: 80d36c1e37e2
Create Date: 2019-03-07 08:41:20.962729

"""
import model.utils
import sqlalchemy as sa
from alembic import op
from sqlalchemy.dialects import mysql

from rdr_service.model.base import add_table_history_table, drop_table_history_table
from rdr_service.participant_enums import OrderShipmentStatus, OrderShipmentTrackingStatus

# revision identifiers, used by Alembic.
revision = "8b20451a84df"
down_revision = "80d36c1e37e2"
branch_labels = None
depends_on = None


def upgrade(engine_name):
    if engine_name == "rdr" or engine_name == "metrics":
        globals()[f"upgrade_{engine_name}"]()
    else:
        pass


def downgrade(engine_name):
    if engine_name == "rdr" or engine_name == "metrics":
        globals()[f"downgrade_{engine_name}"]()
    else:
        pass


def upgrade_rdr():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table(
        "biobank_dv_order",
        sa.Column("id", sa.Integer(), autoincrement=True, nullable=False),
        sa.Column("created", mysql.DATETIME(fsp=6), nullable=False),
        sa.Column("modified", mysql.DATETIME(fsp=6), nullable=False),
        sa.Column("participant_id", sa.Integer(), nullable=False),
        sa.Column("order_id", sa.Integer(), nullable=True),
        sa.Column("order_date", sa.Date(), nullable=True),
        sa.Column("supplier", sa.String(length=80), nullable=True),
        sa.Column("supplier_status", sa.String(length=30), nullable=True),
        sa.Column("item_name", sa.String(length=80), nullable=True),
        sa.Column("item_sku_code", sa.String(length=80), nullable=True),
        sa.Column("item_snomed_code", sa.String(length=80), nullable=True),
        sa.Column("item_quantity", sa.Integer(), nullable=True),
        sa.Column("street_address_1", sa.String(length=255), nullable=True),
        sa.Column("street_address_2", sa.String(length=255), nullable=True),
        sa.Column("city", sa.String(length=255), nullable=True),
        sa.Column("state_id", sa.Integer(), nullable=True),
        sa.Column("zip_code", sa.String(length=10), nullable=True),
        sa.Column("biobank_street_address_1", sa.String(length=255), nullable=True),
        sa.Column("biobank_street_address_2", sa.String(length=255), nullable=True),
        sa.Column("biobank_city", sa.String(length=255), nullable=True),
        sa.Column("biobank_state_id", sa.Integer(), nullable=True),
        sa.Column("biobank_zip_code", sa.String(length=10), nullable=True),
        sa.Column("shipment_last_update", sa.Date(), nullable=True),
        sa.Column("tracking_id", sa.String(length=80), nullable=True),
        sa.Column("biobank_tracking_id", sa.String(length=80), nullable=True),
        sa.Column("order_type", sa.String(length=80), nullable=True),
        sa.Column("order_status", model.utils.Enum(OrderShipmentStatus), nullable=True),
        sa.Column("shipment_carrier", sa.String(length=80), nullable=True),
        sa.Column("shipment_est_arrival", sa.Date(), nullable=True),
        sa.Column("shipment_status", model.utils.Enum(OrderShipmentTrackingStatus), nullable=True),
        sa.Column("barcode", sa.String(length=80), nullable=True),
        sa.Column("biobank_order_id", sa.String(length=80), nullable=True),
        sa.Column("biobank_reference", sa.String(length=80), nullable=True),
        sa.Column("biobank_status", sa.String(length=30), nullable=True),
        sa.Column("biobank_received", model.utils.UTCDateTime6(fsp=6), nullable=True),
        sa.Column("biobank_requisition", sa.Text(), nullable=True),
        sa.ForeignKeyConstraint(["biobank_order_id"], ["biobank_order.biobank_order_id"]),
        sa.ForeignKeyConstraint(["biobank_state_id"], ["code.code_id"]),
        sa.ForeignKeyConstraint(["participant_id"], ["participant.participant_id"]),
        sa.ForeignKeyConstraint(["state_id"], ["code.code_id"]),
        sa.PrimaryKeyConstraint("id"),
        sa.UniqueConstraint("participant_id", "order_id", name="uidx_partic_id_order_id"),
    )
    op.execute(
        "ALTER TABLE biobank_dv_order CHANGE COLUMN `created` `created` DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6);"
    )
    op.execute(
        "ALTER TABLE biobank_dv_order CHANGE COLUMN `modified` `modified` DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6);"
    )
    op.execute("ALTER TABLE biobank_dv_order CHANGE COLUMN `shipment_est_arrival` `shipment_est_arrival` DATETIME(6);")
    op.execute("ALTER TABLE biobank_dv_order CHANGE COLUMN `shipment_last_update` `shipment_last_update` DATETIME(6);")
    op.execute("ALTER TABLE biobank_dv_order CHANGE COLUMN `order_date` `order_date` DATETIME(6);")
    # ### end Alembic commands ###

    # Create a history table for 'biobank_dv_order'.
    add_table_history_table("biobank_dv_order", op)


def downgrade_rdr():

    # drop the history table
    drop_table_history_table("biobank_dv_order", op)

    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table("biobank_dv_order")
    # ### end Alembic commands ###


def upgrade_metrics():
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###


def downgrade_metrics():
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###
