"""

Revision ID: e4eedba5965f
Revises: 93fce807f225
Create Date: 2021-06-01 15:17:01.968058

"""
from alembic import op
import sqlalchemy as sa
import rdr_service.model.utils
from rdr_service.genomic_enums import GenomicReportState

# revision identifiers, used by Alembic.
revision = 'e4eedba5965f'
down_revision = '93fce807f225'
branch_labels = None
depends_on = None


def upgrade(engine_name):
    globals()["upgrade_%s" % engine_name]()


def downgrade(engine_name):
    globals()["downgrade_%s" % engine_name]()


def upgrade_rdr():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('genomic_member_report_states',
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('genomic_set_member_id', sa.Integer(), nullable=False),
    sa.Column('genomic_report_state', rdr_service.model.utils.Enum(GenomicReportState), nullable=True),
    sa.Column('created', sa.DateTime(), nullable=True),
    sa.Column('modified', sa.DateTime(), nullable=True),
    sa.Column('module', sa.String(length=80), nullable=True),
    sa.ForeignKeyConstraint(['genomic_set_member_id'], ['genomic_set_member.id'], ),
    sa.PrimaryKeyConstraint('id')
    )

    op.execute(
        "Insert into genomic_member_report_states (genomic_set_member_id) Select id From genomic_set_member "
        "Where genomic_set_member.genomic_workflow_state in (23,24,25)"
    )

    op.execute(
        "Update genomic_member_report_states INNER Join genomic_set_member "
        "On genomic_set_member.id = genomic_member_report_states.genomic_set_member_id "
        "Set module = 'GEM', genomic_set_member_id = genomic_set_member.id, genomic_report_state = "
        "CASE WHEN genomic_set_member.genomic_workflow_state = 23 THEN 1 "
        "WHEN genomic_set_member.genomic_workflow_state = 24 THEN 2 "
        "WHEN genomic_set_member.genomic_workflow_state = 25 THEN 3 END, created=NOW()"
        "Where genomic_set_member.genomic_workflow_state in (23,24,25)"
    )
    # ### end Alembic commands ###


def downgrade_rdr():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('genomic_member_report_states')
    # ### end Alembic commands ###


def upgrade_metrics():
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###


def downgrade_metrics():
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###

