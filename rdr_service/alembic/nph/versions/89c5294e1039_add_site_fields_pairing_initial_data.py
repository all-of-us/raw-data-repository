"""add site fields, pairing initial data

Revision ID: 89c5294e1039
Revises: 83450fb6b452
Create Date: 2023-01-13 16:46:36.720998

"""
from alembic import op
import sqlalchemy as sa

# revision identifiers, used by Alembic.
revision = '89c5294e1039'
down_revision = '83450fb6b452'
branch_labels = None
depends_on = None


def upgrade(engine_name):
    globals()["upgrade_%s" % engine_name]()


def downgrade(engine_name):
    globals()["downgrade_%s" % engine_name]()


def upgrade_nph():
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('consent_event', sa.Column('participant_id', sa.BigInteger(), nullable=True))
    op.drop_constraint('consent_event_ibfk_1', 'consent_event', type_='foreignkey')
    op.drop_constraint('consent_event_ibfk_2', 'consent_event', type_='foreignkey')
    op.create_foreign_key(None, 'consent_event', 'participant_event_activity', ['event_id'], ['id'],
                          source_schema='nph', referent_schema='nph')
    op.create_foreign_key(None, 'consent_event', 'participant', ['participant_id'], ['id'],
                          source_schema='nph', referent_schema='nph')
    op.create_foreign_key(None, 'consent_event', 'consent_event_type', ['event_type_id'], ['id'],
                          source_schema='nph', referent_schema='nph')
    op.add_column('enrollment_event', sa.Column('participant_id', sa.BigInteger(), nullable=True))
    op.drop_constraint('enrollment_event_ibfk_2', 'enrollment_event', type_='foreignkey')
    op.drop_constraint('enrollment_event_ibfk_1', 'enrollment_event', type_='foreignkey')
    op.create_foreign_key(None, 'enrollment_event', 'enrollment_event_type', ['event_type_id'], ['id'],
                          source_schema='nph', referent_schema='nph')
    op.create_foreign_key(None, 'enrollment_event', 'participant_event_activity', ['event_id'], ['id'],
                          source_schema='nph', referent_schema='nph')
    op.create_foreign_key(None, 'enrollment_event', 'participant', ['participant_id'], ['id'],
                          source_schema='nph', referent_schema='nph')
    op.drop_constraint('order_ibfk_2', 'order', type_='foreignkey')
    op.drop_constraint('order_ibfk_5', 'order', type_='foreignkey')
    op.drop_constraint('order_ibfk_1', 'order', type_='foreignkey')
    op.drop_constraint('order_ibfk_4', 'order', type_='foreignkey')
    op.drop_constraint('order_ibfk_6', 'order', type_='foreignkey')
    op.drop_constraint('order_ibfk_3', 'order', type_='foreignkey')
    op.create_foreign_key(None, 'order', 'site', ['finalized_site'], ['id'],
                          source_schema='nph', referent_schema='nph')
    op.create_foreign_key(None, 'order', 'participant', ['participant_id'], ['id'],
                          source_schema='nph', referent_schema='nph')
    op.create_foreign_key(None, 'order', 'site', ['amended_site'], ['id'],
                          source_schema='nph', referent_schema='nph')
    op.create_foreign_key(None, 'order', 'site', ['collected_site'], ['id'],
                          source_schema='nph', referent_schema='nph')
    op.create_foreign_key(None, 'order', 'study_category', ['category_id'], ['id'],
                          source_schema='nph', referent_schema='nph')
    op.create_foreign_key(None, 'order', 'site', ['created_site'], ['id'],
                          source_schema='nph', referent_schema='nph')
    op.drop_constraint('ordered_sample_ibfk_2', 'ordered_sample', type_='foreignkey')
    op.drop_constraint('ordered_sample_ibfk_1', 'ordered_sample', type_='foreignkey')
    op.create_foreign_key(None, 'ordered_sample', 'ordered_sample', ['parent_sample_id'], ['id'],
                          source_schema='nph', referent_schema='nph')
    op.create_foreign_key(None, 'ordered_sample', 'order', ['order_id'], ['id'],
                          source_schema='nph', referent_schema='nph')
    op.add_column('pairing_event', sa.Column('participant_id', sa.BigInteger(), nullable=True))
    op.drop_constraint('pairing_event_ibfk_1', 'pairing_event', type_='foreignkey')
    op.drop_constraint('pairing_event_ibfk_2', 'pairing_event', type_='foreignkey')
    op.drop_constraint('pairing_event_ibfk_3', 'pairing_event', type_='foreignkey')
    op.create_foreign_key(None, 'pairing_event', 'participant_event_activity', ['event_id'], ['id'],
                          source_schema='nph', referent_schema='nph')
    op.create_foreign_key(None, 'pairing_event', 'site', ['site_id'], ['id'],
                          source_schema='nph', referent_schema='nph')
    op.create_foreign_key(None, 'pairing_event', 'pairing_event_type', ['event_type_id'], ['id'],
                          source_schema='nph', referent_schema='nph')
    op.create_foreign_key(None, 'pairing_event', 'participant', ['participant_id'], ['id'],
                          source_schema='nph', referent_schema='nph')
    op.drop_constraint('participant_event_activity_ibfk_2', 'participant_event_activity', type_='foreignkey')
    op.drop_constraint('participant_event_activity_ibfk_1', 'participant_event_activity', type_='foreignkey')
    op.create_foreign_key(None, 'participant_event_activity', 'participant',
                          ['participant_id'], ['id'], source_schema='nph', referent_schema='nph')
    op.create_foreign_key(None, 'participant_event_activity', 'activity', ['activity_id'], ['id'],
                          source_schema='nph', referent_schema='nph')
    op.add_column('site', sa.Column('organization_external_id', sa.String(length=256), nullable=True))
    op.create_index(op.f('ix_nph_site_awardee_external_id'), 'site', ['awardee_external_id'],
                    unique=False, schema='nph')
    op.create_index(op.f('ix_nph_site_external_id'), 'site', ['external_id'], unique=False, schema='nph')
    op.create_index(op.f('ix_nph_site_organization_external_id'), 'site',
                    ['organization_external_id'], unique=False, schema='nph')
    op.drop_constraint('study_category_ibfk_1', 'study_category', type_='foreignkey')
    op.create_foreign_key(None, 'study_category', 'study_category', ['parent_id'], ['id'],
                          source_schema='nph', referent_schema='nph')
    # ### end Alembic commands ###

    # Initialize Data for NPH
    # Activities
    op.execute("""
            INSERT INTO nph.activity
            (created, modified, ignore_flag, name)
            values 
            (now(), now(), 0, "ENROLLMENT"),
            (now(), now(), 0, "PAIRING"),
            (now(), now(), 0, "CONSENT")
        """)

    # Pairing Event Types
    op.execute("""
            INSERT INTO nph.pairing_event_type
            (created, modified, ignore_flag, name)
            VALUES
            (now(), now(), 0, "INITIAL")
        """)

    # Consent Event Types
    op.execute("""
            INSERT INTO nph.consent_event_type
            (created, modified, ignore_flag, disable_flag, name)
            VALUES
            (now(), now(), 0, 0, "Module 1")
        """)

    # Enrollment Event Types
    op.execute("""
            INSERT INTO nph.enrollment_event_type
            (created, modified, ignore_flag, name)
            VALUES
            (now(), now(), 0, "REFERRED")
        """)

    # Sites
    op.execute("""
            INSERT INTO nph.site
            (created, modified, external_id, name, awardee_external_id, organization_external_id)
            VALUES 
            (now(), now(), 'nph-test-site-1', 'Test Site 1', 'nph-test-hpo-1', 'nph-test-org-1'),
            (now(), now(), 'nph-test-site-2', 'Test Site 2', 'nph-test-hpo-1', 'nph-test-org-1')
        """)


def downgrade_nph():
    op.execute("""DELETE FROM nph.site WHERE TRUE""")
    op.execute("""DELETE FROM nph.enrollent_event_type WHERE TRUE""")
    op.execute("""DELETE FROM nph.consent_event_type WHERE TRUE""")
    op.execute("""DELETE FROM nph.pairing_event_type WHERE TRUE""")
    op.execute("""DELETE FROM nph.activity WHERE TRUE""")

    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(None, 'study_category', schema='nph', type_='foreignkey')
    op.create_foreign_key('study_category_ibfk_1', 'study_category', 'study_category', ['parent_id'], ['id'])
    op.drop_index(op.f('ix_nph_site_organization_external_id'), table_name='site', schema='nph')
    op.drop_index(op.f('ix_nph_site_external_id'), table_name='site', schema='nph')
    op.drop_index(op.f('ix_nph_site_awardee_external_id'), table_name='site', schema='nph')
    op.drop_column('site', 'organization_external_id')
    op.drop_constraint(None, 'participant_event_activity', schema='nph', type_='foreignkey')
    op.drop_constraint(None, 'participant_event_activity', schema='nph', type_='foreignkey')
    op.create_foreign_key('participant_event_activity_ibfk_1', 'participant_event_activity',
                          'activity', ['activity_id'], ['id'])
    op.create_foreign_key('participant_event_activity_ibfk_2', 'participant_event_activity', 'participant',
                          ['participant_id'], ['id'])
    op.drop_constraint(None, 'pairing_event', schema='nph', type_='foreignkey')
    op.drop_constraint(None, 'pairing_event', schema='nph', type_='foreignkey')
    op.drop_constraint(None, 'pairing_event', schema='nph', type_='foreignkey')
    op.drop_constraint(None, 'pairing_event', schema='nph', type_='foreignkey')
    op.create_foreign_key('pairing_event_ibfk_3', 'pairing_event', 'site', ['site_id'], ['id'])
    op.create_foreign_key('pairing_event_ibfk_2', 'pairing_event', 'pairing_event_type', ['event_type_id'], ['id'])
    op.create_foreign_key('pairing_event_ibfk_1', 'pairing_event', 'participant_event_activity', ['event_id'], ['id'])
    op.drop_column('pairing_event', 'participant_id')
    op.drop_constraint(None, 'ordered_sample', schema='nph', type_='foreignkey')
    op.drop_constraint(None, 'ordered_sample', schema='nph', type_='foreignkey')
    op.create_foreign_key('ordered_sample_ibfk_1', 'ordered_sample', 'order', ['order_id'], ['id'])
    op.create_foreign_key('ordered_sample_ibfk_2', 'ordered_sample', 'ordered_sample', ['parent_sample_id'], ['id'])
    op.drop_constraint(None, 'order', schema='nph', type_='foreignkey')
    op.drop_constraint(None, 'order', schema='nph', type_='foreignkey')
    op.drop_constraint(None, 'order', schema='nph', type_='foreignkey')
    op.drop_constraint(None, 'order', schema='nph', type_='foreignkey')
    op.drop_constraint(None, 'order', schema='nph', type_='foreignkey')
    op.drop_constraint(None, 'order', schema='nph', type_='foreignkey')
    op.create_foreign_key('order_ibfk_3', 'order', 'site', ['finalized_site'], ['id'])
    op.create_foreign_key('order_ibfk_6', 'order', 'site', ['collected_site'], ['id'])
    op.create_foreign_key('order_ibfk_4', 'order', 'study_category', ['category_id'], ['id'])
    op.create_foreign_key('order_ibfk_1', 'order', 'site', ['amended_site'], ['id'])
    op.create_foreign_key('order_ibfk_5', 'order', 'site', ['created_site'], ['id'])
    op.create_foreign_key('order_ibfk_2', 'order', 'participant', ['participant_id'], ['id'])
    op.drop_constraint(None, 'enrollment_event', schema='nph', type_='foreignkey')
    op.drop_constraint(None, 'enrollment_event', schema='nph', type_='foreignkey')
    op.drop_constraint(None, 'enrollment_event', schema='nph', type_='foreignkey')
    op.create_foreign_key('enrollment_event_ibfk_1', 'enrollment_event', 'participant_event_activity',
                          ['event_id'], ['id'])
    op.create_foreign_key('enrollment_event_ibfk_2', 'enrollment_event', 'enrollment_event_type',
                          ['event_type_id'], ['id'])
    op.drop_column('enrollment_event', 'participant_id')
    op.drop_constraint(None, 'consent_event', schema='nph', type_='foreignkey')
    op.drop_constraint(None, 'consent_event', schema='nph', type_='foreignkey')
    op.drop_constraint(None, 'consent_event', schema='nph', type_='foreignkey')
    op.create_foreign_key('consent_event_ibfk_2', 'consent_event', 'consent_event_type', ['event_type_id'], ['id'])
    op.create_foreign_key('consent_event_ibfk_1', 'consent_event', 'participant_event_activity', ['event_id'], ['id'])
    op.drop_column('consent_event', 'participant_id')
    # ### end Alembic commands ###

