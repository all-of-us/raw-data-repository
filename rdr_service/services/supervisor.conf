#
# Supervisor configuration file
#
# http://supervisord.org/configuration.html
#
# https://stackoverflow.com/questions/56179319/running-celery-as-a-flask-app-with-gunicorn
#
[supervisord]
logfile=/dev/fd/1
logfile_maxbytes=0
loglevel=info
pidfile=/tmp/supervisord.pid
nodaemon=True

[inet_http_server]
port = 127.0.0.1:9001

[supervisorctl]
serverurl = http://127.0.0.1:9001

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

; [program:pip_list]
; command=pip list
; autostart=true
; autorestart=false
; stdout_logfile=/dev/fd/1
; stdout_logfile_maxbytes=0
; stderr_logfile=/dev/fd/2
; stderr_logfile_maxbytes=0

[program:flask_wsgi]
command=gunicorn -c rdr_service/services/gunicorn_config.py -e RDR_CONFIG_PROVIDER=%(ENV_RDR_CONFIG_PROVIDER)s -e RDR_STORAGE_PROVIDER=%(ENV_RDR_STORAGE_PROVIDER)s rdr_service.main:app
;command=gunicorn -b 0.0.0.0:8081 -w 3 --worker-class gevent rdr_service.wsgi
autostart=true
autorestart=true
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
; redirect_stderr=true

[program:celery]
environment=RDR_CONFIG_PROVIDER=%(ENV_RDR_CONFIG_PROVIDER)s,RDR_STORAGE_PROVIDER=%(ENV_RDR_STORAGE_PROVIDER)s
command=celery -A rdr_service.services.flask:celery worker -n %(ENV_GAE_INSTANCE)s --autoscale=2,1 --loglevel=info
autostart=true
autorestart=true
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
redirect_stderr=true
